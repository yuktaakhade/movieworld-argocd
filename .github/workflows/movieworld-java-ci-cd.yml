name: MovieWorld CI/CD GCP DevSecOps

on:
push:
branches:
- main
pull_request:
branches:
- main

permissions:
contents: read
id-token: write

env:
PROJECT_ID: yuktaaa
REGION: us-central1
IMAGE_NAME: movieworld
ARTIFACT_REPO: movieworld-dockerimage-repo
IMAGE_URI: us-central1-docker.pkg.dev/yuktaaa/movieworld-dockerimage-repo/movieworld
WORKLOAD_IDENTITY_PROVIDER: projects/291263715379/locations/global/workloadIdentityPools/wif-pool/providers/wif-provider
SERVICE_ACCOUNT: [movieworld-service-account@yuktaaa.iam.gserviceaccount.com](mailto:movieworld-service-account@yuktaaa.iam.gserviceaccount.com)
DEPLOYMENT_FILE: kubernetes/manifests/deployment.yaml

jobs:
ci-cd:
name: Build, Scan, Push & GitOps Update
runs-on: ubuntu-latest


steps:
  - name: Checkout source
    uses: actions/checkout@v3

  - name: Set up JDK 17
    uses: actions/setup-java@v3
    with:
      distribution: temurin
      java-version: "17"
      cache: maven

  - name: Run Unit Tests & Package
    run: mvn -B clean test package

  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v3

  - name: Build Docker image
    uses: docker/build-push-action@v5
    with:
      context: .
      load: true
      tags: ${{ env.IMAGE_URI }}:${{ github.sha }}

  - name: Trivy Image Scan
    uses: aquasecurity/trivy-action@master
    with:
      image-ref: ${{ env.IMAGE_URI }}:${{ github.sha }}
      severity: CRITICAL,HIGH
      exit-code: 0

  - name: Authenticate to GCP
    uses: google-github-actions/auth@v2
    with:
      workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
      service_account: ${{ env.SERVICE_ACCOUNT }}

  - name: Configure gcloud & Docker
    run: |
      gcloud config set project "${PROJECT_ID}"
      gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

  - name: Push image to Artifact Registry
    uses: docker/build-push-action@v5
    with:
      context: .
      push: true
      tags: ${{ env.IMAGE_URI }}:${{ github.sha }}

  - name: Update Kubernetes manifest with new image tag
    run: |
      sed -i 's|image: .*|image: '"${IMAGE_URI}:${GITHUB_SHA}"'|' "${DEPLOYMENT_FILE}"

  - name: Commit and push manifest update
    run: |
      git config user.name "github-actions"
      git config user.email "github-actions@github.com"
      git add "${DEPLOYMENT_FILE}"
      git diff --cached --quiet || git commit -m "chore: update movieworld image to ${GITHUB_SHA}"
      git push
