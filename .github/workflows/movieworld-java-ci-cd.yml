name: MovieWorld CI/CD â€“ GCP DevSecOps

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  ci-cd:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: movieworld
      GAR_REGION: us-central1
      GAR_REPO: movieworld-dockerimage-repo
      PROJECT_ID: yuktaaa
      GKE_CLUSTER: app-cluster
      GKE_LOCATION: us-central1-a
      WORKLOAD_IDENTITY_PROVIDER: projects/291263715379/locations/global/workloadIdentityPools/wif-pool/providers/wif-provider
      SERVICE_ACCOUNT: movieworld-service-account@yuktaaa.iam.gserviceaccount.com
      NAMESPACE: movie

    steps:
    # --------------------------------------------------
    # Checkout + Java Build
    # --------------------------------------------------
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '17'
        cache: maven

    - name: Maven test + JaCoCo
      run: mvn -B clean test package jacoco:report

    # --------------------------------------------------
    # Docker Build + Scan
    # --------------------------------------------------
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image (local)
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Trivy image scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
        severity: CRITICAL,HIGH
        exit-code: 0

    # --------------------------------------------------
    # GCP Auth + Artifact Registry Push
    # --------------------------------------------------
    - name: GCP authentication (Workload Identity)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud config set project ${{ env.PROJECT_ID }}
        gcloud auth configure-docker ${{ env.GAR_REGION }}-docker.pkg.dev --quiet

    - name: Push image to Artifact Registry
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.GAR_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    # --------------------------------------------------
    # GKE Deploy
    # --------------------------------------------------
    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_LOCATION }}
        project_id: ${{ env.PROJECT_ID }}

    - name: Deploy base manifests
      run: |
        kubectl apply -f kubernetes/manifests/namespace.yaml
        kubectl apply -f kubernetes/manifests/mysql-sg-pvc.yaml || true
        kubectl apply -f kubernetes/manifests/mysql-secret.yaml
        kubectl apply -f kubernetes/manifests/mysql-deployment.yaml
        kubectl apply -f kubernetes/manifests/mysql-service.yaml
        kubectl apply -f kubernetes/manifests/secret.yaml
        kubectl apply -f kubernetes/manifests/configmap.yaml
        kubectl apply -f kubernetes/manifests/deployment.yaml
        kubectl apply -f kubernetes/manifests/service.yaml

    - name: Update deployment image
      run: |
        kubectl -n ${{ env.NAMESPACE }} set image deployment/movieworld \
        movieworld=${{ env.GAR_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
        --record

    - name: Wait for rollout
      run: |
        kubectl -n ${{ env.NAMESPACE }} rollout status deployment/movieworld --timeout=180s
