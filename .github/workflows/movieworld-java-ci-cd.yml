name: MovieWorld CI/CD â€“ GCP DevSecOps

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  ci-cd:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: movieworld
      GAR_REGION: us-central1
      GAR_REPO: movieworld-dockerimage-repo
      PROJECT_ID: yuktaaa
      GKE_CLUSTER: app-cluster
      GKE_LOCATION: us-central1-a
      WORKLOAD_IDENTITY_PROVIDER: projects/291263715379/locations/global/workloadIdentityPools/wif-pool/providers/wif-provider
      SERVICE_ACCOUNT: movieworld-service-account@yuktaaa.iam.gserviceaccount.com

    steps:
    # ------------------------------------------------------------------
    # Checkout + Java
    # ------------------------------------------------------------------
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '17'
        cache: maven

    # ------------------------------------------------------------------
    # Build + Test + Coverage
    # ------------------------------------------------------------------
    - name: Maven test + JaCoCo
      run: mvn -B clean test package jacoco:report

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: target/surefire-reports/

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: target/site/jacoco/

    # ------------------------------------------------------------------
    # Docker build + scan
    # ------------------------------------------------------------------
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Trivy image scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
        severity: CRITICAL,HIGH
        exit-code: 0

    # ------------------------------------------------------------------
    # GCP Auth + Artifact Registry
    # ------------------------------------------------------------------
    - name: GCP authentication (Workload Identity)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud config set project ${{ env.PROJECT_ID }}
        gcloud auth configure-docker ${{ env.GAR_REGION }}-docker.pkg.dev --quiet

    - name: Push image to Artifact Registry
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.GAR_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    # ------------------------------------------------------------------
    # GKE Deploy (FIXED)
    # ------------------------------------------------------------------
    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_LOCATION }}
        project_id: ${{ env.PROJECT_ID }}

    - name: Deploy to GKE
      run: |
        set -e
        kubectl apply -f kubernetes/manifests/namespace.yaml
        kubectl apply -f kubernetes/manifests/mysql-sg-pvc.yaml || true
        kubectl apply -f kubernetes/manifests/mysql-secret.yaml
        kubectl apply -f kubernetes/manifests/mysql-deployment.yaml
        kubectl apply -f kubernetes/manifests/mysql-service.yaml
        kubectl apply -f kubernetes/manifests/secret.yaml
        kubectl apply -f kubernetes/manifests/configmap.yaml
        kubectl apply -f kubernetes/manifests/deployment.yaml
        kubectl apply -f kubernetes/manifests/service.yaml

        # kubectl -n movie rollout status deployment/movieworld --timeout=120s

# name: MovieWorld CI - GCP DevSecOps

# on:
#   push:
#     branches: [main]
#   pull_request:
#     branches: [main]

# permissions:
#   contents: read
#   id-token: write

# jobs:
#   ci:
#     runs-on: ubuntu-latest

#     env:
#       IMAGE_NAME: movieworld
#       GAR_REGION: us-central1
#       GAR_REPO: movieworld-dockerimage-repo
#       PROJECT_ID: yuktaaa
#       GKE_CLUSTER: app-cluster	
#       GKE_LOCATION: us-central1-a	
#       WORKLOAD_IDENTITY_PROVIDER: 'projects/291263715379/locations/global/workloadIdentityPools/wif-pool/providers/wif-provider'
#       SERVICE_ACCOUNT: 'movieworld-service-account@yuktaaa.iam.gserviceaccount.com'

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Setup JDK 17
#         uses: actions/setup-java@v3
#         with:
#           distribution: temurin
#           java-version: '17'
#           cache: maven

#       - name: Maven test and jacoco
#         run: mvn -B clean test package jacoco:report

#       - name: Upload test results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: test-results
#           path: ./target/surefire-reports/
#           retention-days: 7
#           if-no-files-found: warn

#       - name: Upload coverage report
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: coverage-report
#           path: |
#             ./target/site/jacoco/
#             ./target/site/jacoco.xml
#             ./target/jacoco.exec
#           retention-days: 7
#           if-no-files-found: warn

#       - name: Setup Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Docker build (local)
#         uses: docker/build-push-action@v5
#         with:
#           context: .
#           push: false
#           load: true
#           tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}

#       - name: Trivy scan (report)
#         uses: aquasecurity/trivy-action@master
#         with:
#           image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
#           format: table
#           output: trivy-image-results.txt
#           severity: 'CRITICAL,HIGH'
#           exit-code: '0'

#       - name: Upload Trivy results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: trivy-image-scan-results
#           path: trivy-image-results.txt
#           retention-days: 7

#       - name: GCP authenticate (Workload Identity)
#         uses: google-github-actions/auth@v2
#         with:
#           workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
#           service_account: ${{ env.SERVICE_ACCOUNT }}

#       - name: Configure docker for Artifact Registry
#         run: |
#           gcloud config set project ${{ env.PROJECT_ID }}
#           gcloud auth configure-docker ${{ env.GAR_REGION }}-docker.pkg.dev --quiet

#       - name: Docker push to Artifact Registry
#         uses: docker/build-push-action@v5
#         with:
#           context: .
#           push: true
#           tags: ${{ env.GAR_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

#       - name: Install gke-gcloud-auth-plugin
#         if: ${{ env.GKE_CLUSTER && env.GKE_LOCATION }}
#         run: |
#           # Ensure the plugin is available for kubectl to auth with GKE
#           gcloud components install gke-gcloud-auth-plugin --quiet || true
#           echo "USE_GKE_GCLOUD_AUTH_PLUGIN=true" >> $GITHUB_ENV

#       - name: GKE get credentials
#         if: ${{ env.GKE_CLUSTER && env.GKE_LOCATION }}
#         run: |
#           gcloud container clusters get-credentials "${{ env.GKE_CLUSTER }}" --zone "${{ env.GKE_LOCATION }}" --project "${{ env.PROJECT_ID }}"

#       - name: Apply kubernetes manifests 
#         if: ${{ env.GKE_CLUSTER && env.GKE_LOCATION }}
#         run: |
#           set -e
#           kubectl apply -f kubernetes/manifests/namespace.yaml
#           kubectl apply -f kubernetes/manifests/mysql-sg-pvc.yaml || true
#           kubectl apply -f kubernetes/manifests/mysql-secret.yaml
#           kubectl apply -f kubernetes/manifests/mysql-deployment.yaml
#           kubectl apply -f kubernetes/manifests/mysql-service.yaml
#           kubectl apply -f kubernetes/manifests/secret.yaml
#           kubectl apply -f kubernetes/manifests/configmap.yaml
#           kubectl apply -f kubernetes/manifests/deployment.yaml
#           kubectl apply -f kubernetes/manifests/service.yaml
#           # if kubectl get crd servicemonitors.monitoring.coreos.com >/dev/null 2>&1; then
#           #   kubectl apply -f kubernetes/manifests/service-monitor.yaml
#           # else
#           #   echo "Skipping ServiceMonitor: CRD not present"
#           # fi
#           # kubectl -n movie rollout status deployment/movieworld --timeout=120s || true

      
